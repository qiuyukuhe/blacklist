<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>小家账簿</title>
    <link rel="stylesheet" href="lib/bootstrap-4.0.0-dist/css/bootstrap.min.css">
    <style>
        .col-md-3 input {
        }
    </style>
</head>
<body>


<div class="container">
    <h1 class="align-middle w-100" style="text-align: center; line-height: 200%">公司黑名单</h1>
    <div class="w-50 container">
        <div class="row">
            <div class="col-sm" id="allVale">
            </div>
        </div>
        <br>
        <div class="row">
                <div class="col-sm" id="clothTotal">
                </div>
                <div class="col-sm" id="foodTotal">
                </div>
                <div class="col-sm" id="houseTotal">
                </div>
            </div>
        <div class="row">
            <div class="col-sm" id="trafficTotal">
            </div>
            <div class="col-sm" id="educationTotal">
            </div>
            <div class="col-sm" id="investTotal">
            </div>
        </div>
    </div>
    <br>
    <form class="w-50 col-center-block container" style="border-top: 1px solid #ccc">
        <h3 style="margin-top: 20px">记账</h3>
        <div class="form-row" style="margin-top: 20px">
            <div class="form-group col-md-4" >
                <label for="cloth">衣</label>
                <input type="text" value="0" class="form-control" id="cloth" placeholder="" required="required">
            </div>
            <div class="form-group col-md-4">
                <label for="food">食</label>
                <input type="text" value="0" class="form-control" id="food" placeholder="" required="required">
            </div>
            <div class="form-group col-md-4">
                <label for="house">住</label>
                <input type="text" value="0" class="form-control" id="house" placeholder="" required="required">
            </div>
            <div class="form-group col-md-4">
                <label for="traffic">行</label>
                <input type="text" value="0" class="form-control" id="traffic" placeholder="" required="required">
            </div>
            <div class="form-group col-md-4">
                <label for="traffic">育</label>
                <input type="text" value="0" class="form-control" id="education" placeholder="" required="required">
            </div>
            <div class="form-group col-md-4">
                <label for="invest">投</label>
                <input type="text" value="0" class="form-control" id="invest" placeholder="" required="required">
            </div>
        </div>

        <script src="js/jquery-1.9.1.min.js"></script>
        <script src=lib/bootstrap-4.0.0-dist/js/bootstrap.min.js></script>

        <div class="form-group">
            <label for="bookdate">日期</label>
            <input type="text" class="form-control" id="bookdate" placeholder="记账日期" data-date-format="yyyy-mm-dd" required="required">
        </div>
        <div class="form-group">
            <label for="content">备注</label>
            <textarea class="form-control date-picker" id="content" rows="5" placeholder="备注内容"></textarea>
        </div>
        <br>
        <button id="push" class="btn btn-primary mb-2">提交</button>
        <br>
        <br>
    </form>
</div>


<script src=lib/nebPay.js></script>
<script src=lib/bootstrap-4.0.0-dist/js/bootstrap.min.js></script>
<script src=lib/nebulas.js></script>

<script>
    "use strict";
    var dappAddress = "n1g3xcTK76QzmyY1sr8q1PzbBXhsawuKp6c";

    var NebPay = require("nebpay");     //https://github.com/nebulasio/nebPay
    var nebPay = new NebPay();
    var serialNumber;

    $(function () {
        var to = dappAddress;
        var value = "0";
        var callFunction = "search";
        var callArgs = "";

        serialNumber = nebPay.simulateCall(to, value, callFunction, callArgs, {    //使用nebpay的call接口去调用合约,
            listener: initCharts        //设置listener, 处理交易返回信息
        });
    });

    function initCharts(resp) {
        console.log("response of respone: " + JSON.stringify(resp));
        console.log(resp)
        var dataMap;
        // dataMap = d_Map;
        if (resp.result == 'null' || resp.result == '{}' || typeof(resp.result) == "undefined") {
            alert("没有查询到数据!");
            return;
        }
        else {
            dataMap = eval(JSON.parse(resp.result));
        }

    }


    $("#push").click(function () {

        var to = dappAddress;
        var value = "0";
        var callFunction = "save";

        var data = {
            cloth: $("#cloth").val(),
            food: $("#food").val(),
            house: $("#house").val(),
            traffic: $("#traffic").val(),
            education: $("#education").val(),
            invest: $("#invest").val(),
            bookdate: $("#bookdate").val(),
            content: $("#content").val()
        };

        if(data.bookdate == '' || data.bookdate.trim() == ''){
            alert("请输入记账时间！");
            return false;
        }

        for (var i in data) {
            if (i != 'content' && i != 'bookdate' && isNaN(data[i])) {
                alert("请输入数字！");
                return false;
            }
            if (data[i] == '' || data[i].trim()  == ''){
                data[i] = 0;
            }
        }

        console.log(JSON.stringify(data));
        var callArgs = [];
        callArgs.push(JSON.stringify(data));
        console.log(JSON.stringify(callArgs))
        serialNumber = nebPay.call(to, value, callFunction, JSON.stringify(callArgs), {    //使用nebpay的call接口去调用合约,
            listener: cbPush        //设置listener, 处理交易返回信息
        });

        intervalQuery = setInterval(function () {
            funcIntervalQuery();
        }, 5000);

        return false;
    });

    var intervalQuery;

    function funcIntervalQuery() {
        nebPay.queryPayInfo(serialNumber)   //search transaction result from server (result upload to server by app)
            .then(function (resp) {
                console.log("tx result: " + resp)   //resp is a JSON string
                var respObject = JSON.parse(resp)
                if (respObject.code === 0) {
                    alert('保存成功，稍后刷新查看!');
                    clearInterval(intervalQuery);
                    window.location.reload();
                }
            })
            .catch(function (err) {
                console.log(err);
            });
    }

    function cbPush(resp) {
        console.log("response of push: " + JSON.stringify(resp))
    }
</script>

</body>
</html>