<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <link rel="stylesheet" href="lib/bootstrap-4.0.0-dist/css/bootstrap.min.css">
    <!--<script src="js/jquery-1.9.1.min.js" />-->
    <script src="lib/jquery-3.3.1.min.js" />
    <script src=lib/bootstrap-4.0.0-dist/js/bootstrap.min.js></script>
    <script src="js/angular.min.js"></script>
</head>
<body ng-app="blackBody" ng-controller="blackCtrl">

<div class="container">
    <nav class="navbar navbar-light bg-faded">
        <a class="navbar-brand" href="#" style="font-size: 40px">黑链</a>
        <ul class="nav navbar-nav">
            <li class="nav-item active">
                <a class="nav-link" href="#">首页 <span class="sr-only">(current)</span></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="javaScript:void(0);" data-toggle="modal" data-target="#addModal">爆 料</a>
            </li>
<!--            <li class="nav-item">
                <a class="nav-link" href="#">声明</a>
            </li>-->
            <li class="nav-item">
                <a class="nav-link" href="#">关于</a>
            </li>
        </ul>
        <form class="form-inline navbar-form pull-right">
            <div class="input-group center-block ">
                <input id="search-key" type="text" ng-model="name" placeholder="请输入关键字" class="form-control">
                <div class="input-group-append">
                    <span class="input-group-text" id="search-btn">搜索</span>
                </div>
                </span>
            </div>
        </form>
    </nav>


    <h3 class="text-center" ng-if="kw" style="line-height: 200%">关于{{kw}}的搜索结果</h3>
    <h3 class="text-center" ng-if="!kw" style="line-height: 200%"> &nbsp; &nbsp;最新爆料</h3>
    <div class="row">
        <div class="col-sm-9">
            <p class="" ng-repeat="r in list" style="text-indent:2em;">
                <span class="col-sm-2"></span>
                <a class="list_txt" href="javascript:void(0);" ng-click="details(r.ref)">
                    ○ <!--{{r.sketch}}——-->{{r.company}}
                </a>
            </p>
            <div ng-if="list.length < 1">
                <p class="list_txt">
                    暂无{{kw}}的数据，提交请点击<a href="#" data-toggle="modal" data-target="#myModal">这里</a>
                </p>
            </div>
        </div>
    </div>

   <!-- <ng-include src="'modal.html'"></ng-include>-->
    <!-- Button trigger modal -->
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal">
        Launch demo modal
    </button>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    ...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>




<!--    <form class="w-50 col-center-block container" style="border-top: 1px solid #ccc">
        <h3 style="margin-top: 20px">记账</h3>

        <script src="js/jquery-1.9.1.min.js"></script>
        <script src=lib/bootstrap-4.0.0-dist/js/bootstrap.min.js></script>

        <div class="form-group">
            <label for="bookdate">日期</label>
            <input type="text" class="form-control" id="bookdate" placeholder="记账日期" data-date-format="yyyy-mm-dd" required="required">
        </div>
        <div class="form-group">
            <label for="content">备注</label>
            <textarea class="form-control date-picker" id="content" rows="5" placeholder="备注内容"></textarea>
        </div>
        <br>
        <button id="push" class="btn btn-primary mb-2">提交</button>
        <br>
        <br>
    </form>-->
</div>


<script src=lib/nebPay.js></script>
<script src=lib/nebulas.js></script>

<script>
    "use strict";
    var dappAddress = "n1g3xcTK76QzmyY1sr8q1PzbBXhsawuKp6c";

    var NebPay = require("nebpay");     //https://github.com/nebulasio/nebPay
    var nebPay = new NebPay();
    var serialNumber;

/*    $(function () {
        var to = dappAddress;
        var value = "0";
        var callFunction = "search";
        var callArgs = "";

        // serialNumber = nebPay.simulateCall(to, value, callFunction, callArgs, {
        //     listener: initCharts
        // });
    });*/

    var blackApp = angular.module('blackBody',[]);
    blackApp.controller('blackCtrl', function($scope, $http) {
        $scope.list = [];
        for(var i=0;i< 10;i++) {
            var topic = {};
            topic.sketch = "sdsdsdf";
            topic.company = "sdfsdfd";
            topic.createTime = "ppppppppp";
            $scope.list[i] = topic;
        }

        var search = $('#search-key').val().trim();
        $scope.kw = search;

/*        $(function () {
            var to = dappAddress;
            var value = "0";
            var callFunction = "search";
            var callArgs = "";

            serialNumber = nebPay.simulateCall(to, value, callFunction, callArgs, {
                listener: showData
            });
        });*/
        function showData(resp) {
            console.log("response: " + JSON.stringify(resp));
            console.log(resp)
            var dataMap;
            // dataMap = d_Map;
            if (resp.result == 'null' || resp.result == '{}' || typeof(resp.result) == "undefined") {
                alert("没有查询到数据!");
                return;
            }
            else {
                dataMap = eval(JSON.parse(resp.result));
            }
        };

    });





    $("#push").click(function () {
        var to = dappAddress;
        var value = "0";
        var callFunction = "save";

        var data = {
            cloth: $("#cloth").val(),
            food: $("#food").val(),
            house: $("#house").val(),
            traffic: $("#traffic").val(),
            education: $("#education").val(),
            invest: $("#invest").val(),
            bookdate: $("#bookdate").val(),
            content: $("#content").val()
        };

        if (data.bookdate == '' || data.bookdate.trim() == '') {
            alert("请输入记账时间！");
            return false;
        }

        for (var i in data) {
            if (i != 'content' && i != 'bookdate' && isNaN(data[i])) {
                alert("请输入数字！");
                return false;
            }
            if (data[i] == '' || data[i].trim() == '') {
                data[i] = 0;
            }
        }

        console.log(JSON.stringify(data));
        var callArgs = [];
        callArgs.push(JSON.stringify(data));
        console.log(JSON.stringify(callArgs))
        serialNumber = nebPay.call(to, value, callFunction, JSON.stringify(callArgs), {    //使用nebpay的call接口去调用合约,
            listener: cbPush        //设置listener, 处理交易返回信息
        });

        intervalQuery = setInterval(function () {
            funcIntervalQuery();
        }, 5000);

        return false;
    });

    var intervalQuery;

    function funcIntervalQuery() {
        nebPay.queryPayInfo(serialNumber)   //search transaction result from server (result upload to server by app)
            .then(function (resp) {
                console.log("tx result: " + resp)   //resp is a JSON string
                var respObject = JSON.parse(resp)
                if (respObject.code === 0) {
                    alert('保存成功，稍后刷新查看!');
                    clearInterval(intervalQuery);
                    window.location.reload();
                }
            })
            .catch(function (err) {
                console.log(err);
            });
    }

    function cbPush(resp) {
        console.log("response of push: " + JSON.stringify(resp))
    }
</script>

</body>
</html>